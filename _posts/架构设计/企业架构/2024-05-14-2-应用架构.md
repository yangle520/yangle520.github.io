---
layout: post
title:  现代企业架构框架白皮书 - 应用架构
date:   2024-05-14 01:00:00
categories: 系统设计
tag: 系统设计
author: YangLe
---



# 企业架构之应用架构

应用架构的核心关注点是业务需求是由哪些应用承载的，它们与用户是如何交互的，它们之间的关系以及是如何交互的，它们访问或变更了什么数据。

应用架构的设计主要以应用（Application）的设计为核心。

向外围可以延伸到平台型企业架构对于应用分层，分组的设计。例如：大家关注的以微服务为代表的分布式应用架构，以及此类架构模式下的常见问题，例如微服务如何划分、如何组织 都是应用架构在这个粒度需要关注的问题。

向内部延伸又会涉及到应用内部的架构设计。例如：常见的应用分层设计，领域驱动设计中提到的六边形架构、洋葱模型，包括领域对象的详细建模与设计，都是在应用架构这个粒度需要关注的问题。



## 一、元模型综述

应用架构的内容元模型包括：**端口**、**结构**、**状态** 三个部分。

- 端口：用来对应用的出入口建模，其中包括：应用服务、扩展点
- 结构：用来对 IT 系统的职责、边界建模，其中包括：应用组件、应用、应用组、应用层
- 状态：用来对应用状态的变更建模，其中包括：领域对象、不变量

![图片]({{ '/images/design/企业级应用架构元模型.png' | prepend: site.baseurl }})



## 二、元模型应用

平台化意味着企业 IT 系统的形态从 扁平结构 转向 分层结构。即一部分应用提供可复用的能力，组成底部平台，而其他应用建立在平台之上。另一个提升 IT 支撑响应力的关键是，提升 IT 系统各组成部分的自治性，使得变更能够相对独立的、以小步快跑的方式发生。

应用边界划分不合理会对应对变化产生明显的负面作用：

| 维度     | 粒度过大                                                     | 粒度过细                                                     |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 功能维度 | 多个团队在同一个物理边界内，变更计划和所需资源容易冲突，协作复杂<br />变更实现难度高，质量保障困难或耗时 | 若一个变更常常散布在多个物理边界内，集成、测试、部署负担重、耗时，且常常伴随着高成本的跨团队沟通协调 |
| 运行维度 | 受限于物理边界，无法将故障隔离在局部区域，因故障级联影响业务支撑<br />受限于物理边界，无法按需调整应用的容量，造成资源浪费 | 基础设施升级、变更工作量大、或对团队自动化运维能力要求高<br />平添大量网络通信的开销，反而降低整体性能 |



### 1、划分边界、合理布局

边界划分其实从应用架构视角出发，对功能、运行层面变化的应对设计，是应用架构设计的重要部分。在进行应用架构设计过程中，融合了领域驱动设计中的限界上下文与统一语言的概念，延续业务架构部分中对于领域对象的识别和子域划分，结合组织与技术的要素，从多个方面充分考量对于应用的建模。

- **限界上下文**（Boundary Context）：是业务上下文的边界，在该边界内，当我们去交流某个业务概念时，不会产生理解和认识上的歧义（二义性），限界上下文是统一语言的重要保证。
- **统一语言**（Ubiquitous Language）：是 Eric Evans 在《领域驱动设计》中使用的术语，用于构建由团队，开发人员，领域专家和其他参与者共享的语言，也称为无处不在的语言、通用语言、泛在语言。统一语言是在限界上下文中建模的，在其中标识表达了业务领域的术语和概念，并且不应该有歧义。



带着对于业务上下文边界的理解，使用业务、技术都能理解的统一语言，以两大阶段实现边界划分：

1. 从功能需求层面出发，按 "单一职责" 原则划分逻辑边界
2. 加入非功能需求，按架构质量属性调整逻辑边界并划分物理边界



#### 1.1 应用组建模

应用组是一种大比例结构的逻辑边界划分结构，其主要作用是：

- 应用组作为一种粗粒度的划分，帮助我们快速找到进一步划分的切入点
- 在微服务化的大背景下，物流边界逐步碎片化，我们在与利益干系人对话时，需要一个能够代表一组相关物流边界的结构，以避免不必要的细节干扰

在结构上，应用组包含了多个应用（物流边界）。应用组常常对应到数字化产品级别，例如 CRM系统（客户关系管理系统，其下包含客户档案管理应用、客户忠诚度管理应用）；在业界流行的按中心划分的中台/平台 架构里，应用组常常对应到某个中心。

应用组的建模依据主要来自于业务架构的业务、组织两部分成果的输入。在 0 到 1 的应用架构设计场景里，这个步骤不求精确，主要是帮助我们建立划分的起点。



#### 1.2 应用组件建模

应用组件是一种细粒度的应用逻辑边界划分结构，是对功能、数据的封装。

向上，一个或多个应用组件可组成一个应用（物理边界）。向下，就是代码层面的结构设计了。因此，应用组件是架构层面运用 **单一职责** 原则的最小单元。

按职责类型分解，应用组件可分为四种常见的参考类型：

| 类型   | 功能                           | 数据                                         | 例子                                                         | 变化原因               |
| ------ | ------------------------------ | -------------------------------------------- | ------------------------------------------------------------ | ---------------------- |
| 流转类 | 支撑某个流程或流程中的一段活动 | 流程的状态流转信息和决策证据                 | 结账组件，其支撑的流程是结账流程，管理的数据是订单           | 流程编排变化           |
| 规格类 | 支撑某个业务规则，给出专业意见 | 一般不管理数据的生命周期，只负责加工给出结果 | · 验证：如发票是否逾期<br />· 筛选：三月内消费过的客户<br />· 计算：计价、导航路线建议 | 业务规则的计算逻辑变化 |
| 视图类 | 支撑某个业务活动所需的整合信息 | 一般不管理数据的生命周期，只负责加工给出结果 | · 商品信息的整合展示<br />· 统计报表                         | 视图组装逻辑变化       |
| 配置类 | 为前三类提供配置输入           | 基础的资源信息                               | 商品目录设置内容管理系统中的配置功能规则的开关               | 前三类对配置要求的变化 |

一般来说，我们建议从流转类的应用组件开始识别，再延伸至规格类、视图类、最后再识别配置类。建模依据主要来自业务架构的业务流程、业务对象、业务规则。其过程可总结为三个子步骤：

##### 1.2.1 功能和数据识别

逐层分解业务流程，从活动、任务、步骤中可以得到相对细粒度的业务需求，即 IT 系统需要提供的功能；将业务对象转化为不同类型的数据对象。

##### 1.2.2 功能与数据关联

按不同组件类型将功能与数据对象关联对应，得出应用组件。在流转类组件建模时，有两个关注点需要特别注意：

一是隐式业务边界的识别。在对业务流程分析时，地点、角色变化时，我们面对的业务干系人和他们的工作环境不同，其关注点可能不同，这往往会成为不同的变化原因。通过识别这类隐式的业务边界，这可以帮助我们细分数据对象和应用组件。

二是数据对象变更一致性约束的识别。在流转类应用组件的建模过程，应该尽可能识别业务规则中对于数据对象变更的一致性约束，以元模型中的 **不变量** 建模。不变量代表了哪些数据对象需要被同时改变，我们可以依此复查，是否将应用组件拆分的太细，破坏了事务边界。

![图片]({{ '/images/design/服务-组件-数据-不变量的关联.png' | prepend: site.baseurl }})

##### 1.2.3 识别调整各应用组件之间的依赖关系

识别各组件间的依赖关系，在这里尽可能避免两种依赖：

- 尽可能避免依赖容易变化的组件。尽管可以定义契约，但容易变化的组件容易打破先前定义的契约
- 尽可能避免出现双向依赖。双向依赖往往对可适配性产生负面影响，可通过引入第三个组件或扩展点解耦。

![图片]({{ '/images/design/将双向依赖转换为单向依赖.png' | prepend: site.baseurl }})



#### 1.3 应用建模

有了应用组件作为原料，应用架构的物理边界设计就有了输入，下一步的目标是识别是否存在架构质量属性冲突，作为应用建模的重要参考，调整逻辑边界，并确定物理边界。质量属性冲突包括：

1. 该边界内是否存在变更频率冲突
   - 我们倾向于将高频变更的应用组件与其他应用组件阻隔开。物理边界意味着部署的独立性，不容易产生发布计划、部署所需资源上的冲突。如果一个功能扩展带来的变更，集中在某个应用、甚至应用组件内，其协作成本相对更低
2. 该边界内是否有特别的移植性要求
   - 该要求指应用迁移到不同组织、业务运作方式的能力，或者换一个角度来说是应用承接业务模式的能力，这恰巧是平台所需要的关键能力。在实现某一个业务模式时，必然存在该业务模式的特定需求和可以支持多个业务模式的公共需求。我们倾向于将特定需求和公共需求的实现隔离到不同的应用组件、甚至应用里。以便新业务模式入住时，方便实现功能扩展以及实现部署要求
3. 该边界内是否有特别的弹性要求
   - 该要求指应用是否容易通过调整容量来应对流量变化。在这里应用的粒度决定了容量调整的难度和成本。因为应用的粒度太大，而流量变化只影响其中某个应用组件，则扩容带来了不必要的成本浪费。
   - 另一种情况是某个应用组件不能调整容量或者非常困难，这主要是因为其依赖于某个无法扩展的技术组件。例如：依赖硬件加密设备对报文进行加密，扩容意味着需要采买硬件加密设备。因此需要将这类应用组件隔离开，使其他组件更容易应对弹性要求。
4. 该边界内是否有特别的性能要求
   - 该要求与弹性要求类似，将不同性能要求（请求处理快慢程度）的应用组件分开，特别是对于特定问题，可能适合某个技术栈，但出于整体建设、运维成本考虑并适合大面积使用，我们倾向于将其设计为一个独立的应用，与其他应用组件隔离开，使其异构。典型的例子是，部分高性能场景适合用C语言实现
5. 该边界内是否有特别的可用性要求
   - 该要求去弹性要求类似，将不同可用性要求的应用组件分开，降低保障可用性要求的建设、运维成本。例如：如果某个应用组件支撑的功能尚处在业务探索阶段，那么可适当降低其可用性要求，这要求将其与承担核心功能的应用组件隔开。或是当故障发生时，能否将故障隔离在局部范围内，减少应用失效造成的业务损失
6. 该边界内是否有特别的信息安全要求
   - 例如：某应用组件需要保管信用卡持卡人信息，为降低该信息被非授权访问的风险，我们倾向于将该应用组件与其他应用组件拆开，将其独立部署在一个加固的运行环境中。
7. 该边界内是否有特别的合规要求
   - 有时边界划分会受到法律、法规或行业规定的影响。例如：某业务是需要公证的抽奖活动，按照当地行业要求，中奖人抽取的实现需要通过公证处认证。我们倾向于由已通过认证的外部应用服务来提供该职责，或是将该职责独立划分为一个应用，减少认证需要花费的时间



#### 1.4 应用层建模

除了应用组之外，常见的一种大比例结构是分层，因此我们也将应用层作为一种元素加入进来。我们认为分层代表了企业对变化速率的认知，并为不同的变化速率匹配架构设计目标和管理方法。并不是所有的 IT 系统都需要"最高配"的架构属性，实现成本也是重要的约束条件。一个处在业务探索期的信息系统，其生命周期一般只有6-12个月，且变化剧烈。为其达成过高的架构属性显然不具备投资合理性的。

另一方面，平台化架构中作为支撑层的 IT 系统在架构属性上需要更多重视和投入。我们常常看到企业仅仅在全景图纸上做了分层，但缺少架构设计、治理中的实际举措，功能上的变更往往会击穿多层，支撑层团队疲于奔命。

因此，如果对分层做出设计，那么在职责划分上就要做出应对，否则分层容易成为空中楼阁。



#### 1.5 应用服务与扩展点建模

元模型中的应用服务最主要的作用是显式地向对外定义一个契约。这在做应用组件升级/替换、定义 IT 服务级别等架构治理场景中会有帮助。应用服务可用来对一组相关的应用组件功能集合建模。例如：

> 在线上订餐流程中，用户需要 IT 系统支持提交订单、发起付款、订单状态查看、取消订单 四个行为，可将他们建模为应用服务 -- 订餐结账

应用服务的来源可以是 自动化 的业务服务，如果在业务架构采用了 能力建模 也可以直接将其构建模块转换过来：

- **能力组件** 转换为 **应用服务**
- **基础能力** 转换为 **功能**

另一方面，如果说应用服务显式定义了应用组件的入口，那么扩展点则显式定义了应用组件的出口。扩展点有两个作用：

1. 反转对不稳定应用组件的依赖，降低其变化对自身的冲击，这在 **应用组件建模** 一节中有提到。
2. 增强可移植性质量属性，即不同的业务场景下对于同一个应用组件的逻辑存在差异化需求，对业务架构的 **变化点**，根据当前应用状态上下文中的业务身份，针对性选择合适的逻辑实现。例如：

> 某公司有零售门店，销售零售商品，同时在店内还有餐厅，我们可以将客户结账识别为一个可共享服务。结账后，商品订单需要派单至仓库提货，而餐厅订单需要派单至厨房备餐，这需要使用 **放行履约** 这个扩展点，并找到两种业务模式的扩展实现关系。

![图片]({{ '/images/design/典型的扩展点建模结果.png' | prepend: site.baseurl }})

总结来说，应用服务和扩展点是对边界概念的加强，帮助我们理解跨边界的交互。



#### 1.6 边界划分结果和依据的可视化

我们常常见到这也的问题：新的功能应该放在哪个应用实现？

这个问题背后的原因可能是应用的边界划分不清晰，职责模糊，或者是边界划分的结果及依据丢失了。常见的现象是我们看到一张张应用架构全景图，由若干个方框组成，代表一个应用或应用组件。由于缺少上下文，仅凭方框内的名字很难判断应用的职责范围，所以不好回答 **新的功能应该放在哪个应用实现** 这样的问题。

解决这个问题的难点是如何简练、清晰的描述应用的边界和职责。在全景图的基础上，为每个应用/应用组件增加职责描述是一个不错的起点，但仅用文字描述可能存在歧义。我们建议通过建立应用架构与业务架构、数据架构的构建块映射来解决这个问题。

![图片]({{ '/images/design/典型的业务架构-应用架构-数据架构的构建块映射关系.png' | prepend: site.baseurl }})

通过构建块映射关系（业务流程使用应用服务，应用服务由应用组件提供，应用组件操作数据对象），应用 / 应用组件在业务活动中的职责有了明确的表达，再配合文字来描述引导阅读和理解，效果更佳。我们推荐为每个应用组 / 应用 / 应用组件建立自己的主页，将其与其他元素的映射关系作为内容显示地展示出来。

最后，应用架构阶段更像是在为 IT 系统应该建设成什么样子提出要求，所以应用架构设计应该是和技术实现方案解耦的（虽然技术的升级可能使得应用架构的设计风格产生变化），从而将技术变化隔离在可控范围内。

![图片]({{ '/images/design/典型的应用-应用组件画布.png' | prepend: site.baseurl }})
