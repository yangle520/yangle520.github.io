---
layout: post
title:  任务调度系统
subtitle:
author: YangLe
date:   2024-05-9 00:00:00 +0800
categories: 定时任务
tag: 定时任务
sidebar: []
excerpt_image:
---





## 一、定时任务

### 1、为什么需要定时任务

1. 时间驱动/事件驱动：内部系统一般可以通过事件来驱动，但涉及到外部系统，则只能使用时间驱动。如怕取外部网站价格，每小时爬一次
2. 批量处理/逐条处理：批量处理堆积的数据更加高效，在不需要实时性的情况下比消息中间件更有优势。而且有的业务逻辑只能批量处理。如移动每个月结算我们的话费
3. 实时性/非实时性：消息中间件能够做到实时处理数据，但是有些情况下并不需要实时，比如：vip升级
4. 系统内部/系统解耦：定时任务调度一般是在系统内部，而消息中间件可用于两个系统间

### 2、定时任务种类

1. 飞机型：固定的某一刻，比如每天1点要执行一个跑批任务去清理前一天的日志；每月10号要给公司全员发工资
2. 地铁型：固定的时间间隔，不可并发。前一个任务没有结束，下一个不可以执行。
3. 公交型：固定的时间间隔，可并发。前一个任务没有结束，下一个任务也可以按点开始

### 3、常见问题

1. 遗忘，忘记了还在运行的定时任务
2. 单点，就是没有热备，跑批任务是一个单点运行的定时任务，出了故障需要转入手工处理。
3. 依赖，利用时间差来处理依赖反复造成问题数据。

### 4、关系

1. 串行：存在先后关系的两个任务。即任务B在任务A后执行，要先执行任务A之后再执行任务B。
2. 并行：可以并发执行的两个任务。比如任务B和C都要在任务A之后执行，而任务A执行完成后，任务B和C可以同时执行，那B和C就是并行关系。
3. 分支：根据前置任务的返回结果进行判断，不同的结果执行不同的后续任务。比如返回0的时候，执行任务A，返回1的时候执行任务B，这是一种分支的情况。



## 二、任务调度功能演进

### 1、演进

当我们应用复杂度升高，定时任务数量增多且任务之间产生依赖关系时，Crontab 进行定时任务的管理配置，就会非常混乱，严重影响工作效率。这时候就会产生一系列问题：

- 任务管理混乱，生命周期无法统一协调管理；
- 任务之间如果存在依赖关系，难以编排；

随着互联网的发展，分布式服务架构势越来越流行。相应也需要一个分布式任务调度系统来管理分布式架构中的定时任务。

通常我们采用分布式或者微服务架构，将核心业务抽取出来，形成单独的服务。一个独立的微服务群体逐渐形成稳定的服务中心，使得业务应用能更快地响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架成为关键。同时，由于服务独立，一般能做到定时任务独立的情况，任务的更改对于整体系统的影响小之又小。一般我们会采用任务与调度分离的方式，任务的执行逻辑无需关注调度与编排，同时可以保证执行器和调度的高可用，易于开发和维护。

### 2、分布式任务调度优势

将任务的配置单独抽离出来，作为该分布式任务调度系统的功能，就能做到定时任务的更改不影响任何业务，也不影响整个系统：

- 通过调度与任务分离的方式进行管理，大大降低了开发和维护成本；
- 分布式部署，保证了系统的高可用性，伸缩性，负载均衡，提高了容错性；
- 可以通过控制台部署和管理定时任务，方便灵活高效；
- 任务都可以持久化到数据库，避免了宕机和数据丢失带来的隐患，同时有完善的任务失败重做机制和详细的任务跟踪及告警策略。





## 三、常见定时任务框架/平台



### 1、单机

#### 1.1 Timer

一个定时器类，通过该类可以为指定的定时任务进行配置。TimerTask类是一个定时任务类，该类实现了Runnable接口，缺点异常未检查会中止线程

#### 1.2 ScheduledExecutorService

相对延迟或者周期作为定时任务调度，缺点没有绝对的日期或者时间

### 2、分布式框架

#### 2.1 Quartz

Java事实上的定时任务标准。但Quartz关注点在于定时任务而非数据，并无一套根据数据处理而定制化的流程。虽然Quartz可以基于数据库实现作业的高可用，但缺少分布式并行调度的功能

#### 2.2 Elastic-job

当开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片，并且可以支持云开发

#### 2.3 xxl-job

大众点评员工徐雪里于2015年发布的分布式任务调度平台，是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。

#### 2.4 Saturn

唯品会自主研发的分布式的定时任务的调度平台，基于当当的elastic-job 版本1开发，并且可以很好的部署到docker容器上。



### 3、分布式平台

#### 3.1 Apache DolphinScheduler



#### 3.2 Oozie



#### 3.3 Azkaban



#### 3.4 Cascading



#### 3.5 SIA-TASK

SIA-TASK 是任务调度的一体式解决方案。对任务进行元数据采集，然后进行任务可视化编排，最终进行任务调度，并且对任务采取全流程监控，简单易用。对业务完全无侵入，通过简单灵活的配置即可生成符合预期的任务调度模型。

SIA-TASK 借鉴微服务的设计思想，获取分布在每个任务执行器上的任务元数据，上传到任务注册中心。利用在线方式进行任务编排，可动态修改任务时钟，采用 HTTP 作为任务调度协议，统一使用 JSON 数据格式，由调度中心进行时钟解析，执行任务流程，进行任务通知