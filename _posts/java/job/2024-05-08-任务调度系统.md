---
layout: post
title:  任务调度系统
subtitle:
author: YangLe
date:   2024-05-08 00:00:00
categories: 定时任务
tag: 定时任务
---





## 一、定时任务

### 1、为什么需要定时任务

1. 时间驱动/事件驱动：内部系统一般可以通过事件来驱动，但涉及到外部系统，则只能使用时间驱动。如怕取外部网站价格，每小时爬一次
2. 批量处理/逐条处理：批量处理堆积的数据更加高效，在不需要实时性的情况下比消息中间件更有优势。而且有的业务逻辑只能批量处理。如移动每个月结算我们的话费
3. 实时性/非实时性：消息中间件能够做到实时处理数据，但是有些情况下并不需要实时，比如：vip升级
4. 系统内部/系统解耦：定时任务调度一般是在系统内部，而消息中间件可用于两个系统间

### 2、定时任务种类

1. 飞机型：固定的某一刻，比如每天1点要执行一个跑批任务去清理前一天的日志；每月10号要给公司全员发工资
2. 地铁型：固定的时间间隔，不可并发。前一个任务没有结束，下一个不可以执行。
3. 公交型：固定的时间间隔，可并发。前一个任务没有结束，下一个任务也可以按点开始

### 3、常见问题

1. 遗忘，忘记了还在运行的定时任务
2. 单点，就是没有热备，跑批任务是一个单点运行的定时任务，出了故障需要转入手工处理。
3. 依赖，利用时间差来处理依赖反复造成问题数据。

### 4、关系

1. 串行：存在先后关系的两个任务。即任务B在任务A后执行，要先执行任务A之后再执行任务B。
2. 并行：可以并发执行的两个任务。比如任务B和C都要在任务A之后执行，而任务A执行完成后，任务B和C可以同时执行，那B和C就是并行关系。
3. 分支：根据前置任务的返回结果进行判断，不同的结果执行不同的后续任务。比如返回0的时候，执行任务A，返回1的时候执行任务B，这是一种分支的情况。



## 二、调度系统

### 1、背景

当我们应用复杂度升高，定时任务数量增多且任务之间产生依赖关系时，Crontab 进行定时任务的管理配置，就会非常混乱，严重影响工作效率。这时候就会产生一系列问题：

- 任务管理混乱，生命周期无法统一协调管理；
- 任务之间如果存在依赖关系，难以编排；

通常我们采用分布式或者微服务架构，将核心业务抽取出来，形成单独的服务。一个独立的微服务群体逐渐形成稳定的服务中心，使得业务应用能更快地响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架成为关键。同时，由于服务独立，一般能做到定时任务独立的情况，任务的更改对于整体系统的影响小之又小。一般我们会采用任务与调度分离的方式，任务的执行逻辑无需关注调度与编排，同时可以保证执行器和调度的高可用，易于开发和维护。

### 2、定义

任务调度系统主要对任务的执行进行调度和管理。调度系统定义任务的规则和属性，对任务的执行顺序和逻辑进行编排，确保任务的高效执行。

将任务的配置单独抽离出来，作为任务调度系统的功能，就能做到定时任务的更改不影响任何业务，也不影响整个系统：

- 通过调度与任务分离的方式进行管理，大大降低了开发和维护成本；
- 分布式部署，保证了系统的高可用性，伸缩性，负载均衡，提高了容错性；
- 可以通过控制台部署和管理定时任务，方便灵活高效；
- 任务都可以持久化到数据库，避免了宕机和数据丢失带来的隐患，同时有完善的任务失败重做机制和详细的任务跟踪及告警策略。

### 3、基本功能

#### 3.1 任务编排管理

调度系统最基本的功能是任务的定义和任务编排。

- 任务定义：主要确定数据计算和加工的逻辑和规则，包括任务执行的频次、具体执行时间，对应的执行脚本和参数等内容。
- 任务编排主要是确定不同任务的先后关系，确保各任务有序进行。任务编排的输出结果是一个DAG图[有向无环图]。

#### 3.2 任务重跑

任务执行完成后，如果我们发现结果数据存在异常，经过定位分析后确定需要对数据重新处理，此时需要使用任务重跑功能。一般情况下，重跑只让当前任务重新执行一次；特殊场景下，当前任务重跑成功后会紧接着重跑该任务后续的其他任务，保证所有可能受到影响的任务都能得到正确的结果。

同时调度系统还提供了终止任务、暂停任务等其他常用操作。

#### 3.3 历史补数

任务创建完成后，调度系统会根据其定义的执行频次和具体时间规则，自动处理新的数据。而对于任务创建前已经产生的历史数据，则需要使用历史补数功能。

重跑和历史补数的区别在：历史补数对应的数据从来没有处理过，而重跑处理的数据此前已经处理过至少一次。

#### 3.4 日志查看

调度系统会及时搜集、保存任务执行过程中的产生日志信息。我们可以检索和查看任务执行的详细日志。

通过日志查看功能，我们可以方便的了解和查找任务运行的详细记录，为错误排查和定位提供了有力的工具。

#### 3.5 运行监控

调度系统的运行监控功能，方便我们及时掌握任务的执行状态，以便及时对异常进行干预和处理。

不同的调度系统其监控方式可能不尽相同。但一般而言，会包括任务执行错误告警及执行延迟告警两种模式。同时还可以在此基础上开发或定制自己的监控策略。



## 三、常见定时任务框架

### 1、单机

#### 1.1 Timer

一个Java定时器类，通过该类可以为指定的定时任务进行配置。TimerTask类是一个定时任务类，该类实现了Runnable接口，缺点异常未检查会中止线程

#### 1.2 ScheduledExecutorService

相对延迟或者周期作为定时任务调度，缺点没有绝对的日期或者时间

#### 1.3 Spring Task

Spring 3.0 之后，提供了一种简单的定时任务 Spring Task。

### 2、分布式框架

#### 2.1 Quartz

Java事实上的定时任务标准。但Quartz关注点在于定时任务而非数据，并无一套根据数据处理而定制化的流程。虽然Quartz可以基于数据库实现作业的高可用，但缺少分布式并行调度的功能

#### 2.2 Elastic-job

当开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片，并且可以支持云开发

#### 2.3 xxl-job

大众点评员工徐雪里于2015年发布的分布式任务调度平台，是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。

#### 2.4 Saturn

唯品会自主研发的分布式的定时任务的调度平台，基于当当的elastic-job 版本1开发，并且可以很好的部署到docker容器上。





## 四、常见调度系统

### 1、开源

#### 1.1 Oozie

一个基于工作流引擎的开源框架，Oozie需要部署到java servlet中运行，主要用于定时调度，多任务之间按照执行的逻辑顺序调度。

官方文档：https://oozie.apache.org/



#### 1.2 Azkaban

Azkaban是由Linkedin开源的一个批量工作流任务调度器。用于在一个工作流内以一个特定的顺序运行一组工作和流程。Azkaban定义了一种KV文件格式来建立任务之间的依赖关系，并提供一个易于使用的web用户界面维护和跟踪你的工作流。

官方文档：https://azkaban.github.io/



#### 3.5 SIA-TASK

SIA-TASK 是任务调度的一体式解决方案。对任务进行元数据采集，然后进行任务可视化编排，最终进行任务调度，并且对任务采取全流程监控，简单易用。对业务完全无侵入，通过简单灵活的配置即可生成符合预期的任务调度模型。

SIA-TASK 借鉴微服务的设计思想，获取分布在每个任务执行器上的任务元数据，上传到任务注册中心。利用在线方式进行任务编排，可动态修改任务时钟，采用 HTTP 作为任务调度协议，统一使用 JSON 数据格式，由调度中心进行时钟解析，执行任务流程，进行任务通知

仓库：https://github.com/siaorg/sia-task