---
layout: post
title:  腾讯云接口对接
date:   2024-03-21
categories: 腾讯云
tag: 腾讯云
author: YangLe
---

接口调用示例

```java
package com.smart.mine.voice.manager.speech;

import cn.hutool.core.codec.Base64Decoder;
import cn.hutool.core.lang.UUID;
import cn.hutool.core.util.RandomUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import com.alibaba.fastjson2.JSONObject;
import com.smart.mine.voice.dto.speech.SpeechTencentCommand;
import com.smart.mine.voice.manager.FileSaveManager;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.xml.bind.DatatypeConverter;
import java.util.TreeMap;

@Component
@Slf4j
public class TencentSpeechManager {
    @Resource
    private FileSaveManager fileSaveManager;

    @Value("${speech.tencent.Id:XXX}")
    private String secretId;
    @Value("${speech.tencent.Key:XXX}")
    private String secretKey;

    @Value("${speech.tencent.host:tts.tencentcloudapi.com}")
    private String host;
    @Value("${speech.tencent.speechUrl:https://tts.tencentcloudapi.com/}")
    private String speechUrl;
    private final static String CHARSET = "UTF-8";

    /**
     * 通用语音合成
     * 官方文档：https://cloud.tencent.com/document/api/1073/37995
     */
    public String createShortSpeech(SpeechTencentCommand command) {
        // 构造参数
        TreeMap<String, Object> params = new TreeMap<>();
        params.put("SecretId", secretId);
        params.put("Timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        params.put("Nonce", RandomUtil.randomInt(0, 10));
        params.put("Action", "TextToVoice");
        params.put("Version", "2019-08-23");
        params.put("Text", command.getText());
        params.put("SessionId", UUID.randomUUID().toString());
        params.put("Volume", command.getVolume() != null ? command.getVolume() : 0);
        params.put("Speed", command.getSpeed() != null ? command.getSpeed() : 0);
        params.put("Codec", "mp3");
        params.put("Signature", sign(getStringToSign(params), secretKey, "HmacSHA1"));

        log.info("[腾讯云][短语音生成] 参数：" + params);

        HttpRequest request = HttpRequest.post(speechUrl)
                .timeout(10000)
                .header("Accept", "application/json")
                .contentType("application/x-www-form-urlencoded")
                .form(params);

        HttpResponse response = request.execute();
        log.info("[腾讯云][短语音生成] 响应 " + response.body());

        if (StrUtil.isNotBlank(response.body())) {
            JSONObject json = JSONObject.parseObject(response.body()).getJSONObject("Response");
            if (StrUtil.isNotBlank(json.getString("Audio"))) {
                log.info("[腾讯云][短语音生成] 保存 ");
                return fileSaveManager.saveVoiceFile(Base64Decoder.decode(json.getString("Audio")));
            } else if (json.containsKey("Error")) {
                log.info("[腾讯云][短语音生成] 异常 " + json.getJSONObject("Error"));
                return json.getJSONObject("Error").getString("Message");
            }
        }

        return "";
    }

    /**
     * 长语音合成
     * 官方文档：https://cloud.tencent.com/document/api/1073/57373
     */
    public String createLongSpeech(SpeechTencentCommand command) {
        TreeMap<String, Object> params = new TreeMap<>();
        params.put("Action", "CreateTtsTask");
        params.put("Version", "2019-08-23");
        params.put("Text", command.getText());
        params.put("Volume", command.getVolume() != null ? command.getVolume() : 0);
        params.put("Speed", command.getSpeed() != null ? command.getSpeed() : 0);
        params.put("Codec", "mp3");
        params.put("SecretId", secretId);
        params.put("Timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        params.put("Nonce", RandomUtil.randomInt(0, 10));
        params.put("Signature", sign(getStringToSign(params), secretKey, "HmacSHA1"));

        log.info("[腾讯云][长语音生成] 参数：" + params);

        HttpRequest request = HttpRequest.post(speechUrl)
                .timeout(10000)
                .header("Accept", "application/json")
                .contentType("application/x-www-form-urlencoded")
                .form(params);

        HttpResponse response = request.execute();
        log.info("[腾讯云][长语音生成] 响应 " + response.body());

        if (StrUtil.isNotBlank(response.body())) {
            JSONObject json = JSONObject.parseObject(response.body()).getJSONObject("Response");
            if (json.containsKey("Data")) {
                String taskId = json.getJSONObject("Data").getString("TaskId");
                if (StrUtil.isNotBlank(taskId)) {
                    //  获取结果
                    return querySpeechResult(taskId);
                }
            } else if (json.containsKey("Error")) {
                log.error("[腾讯云][长语音生成] 异常 " + json.getJSONObject("Error"));
                return json.getJSONObject("Error").getString("Message");
            }
        }

        return "";
    }

    private String querySpeechResult(String taskId) {
        TreeMap<String, Object> params = new TreeMap<>();
        params.put("Action", "CreateTtsTask");
        params.put("Version", "2019-08-23");
        params.put("TaskId", taskId);
        params.put("SecretId", secretId);
        params.put("Timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        params.put("Nonce", RandomUtil.randomInt(0, 10));
        params.put("Signature", sign(getStringToSign(params), secretKey, "HmacSHA1"));

        log.info("[腾讯云][长语音查询] 参数：" + params);

        HttpRequest request = HttpRequest.post(speechUrl)
                .timeout(10000)
                .header("Accept", "application/json")
                .contentType("application/x-www-form-urlencoded")
                .form(params);

        HttpResponse response = request.execute();
        log.info("[腾讯云][长语音查询] 响应 " + response.body());

        if (StrUtil.isNotBlank(response.body())) {
            JSONObject json = JSONObject.parseObject(response.body()).getJSONObject("Response");
            if (json.containsKey("Data")) {
                String resultUrl = json.getJSONObject("Data").getString("TaskId");
                if (StrUtil.isNotBlank(resultUrl)) {
                    //  获取结果
                    log.info("[腾讯云][长语音查询] 保存 " + resultUrl);
                    return fileSaveManager.saveVoiceFileByURL(resultUrl);
                }
            } else if (json.containsKey("Error")) {
                log.info("[腾讯云][长语音查询] 异常 " + json.getJSONObject("Error"));
                return json.getJSONObject("Error").getString("Message");
            }
        }
        return "";
    }

    public static String sign(String s, String key, String method) {
        try {
            Mac mac = Mac.getInstance(method);
            SecretKeySpec secretKeySpec = new SecretKeySpec(key.getBytes(CHARSET), mac.getAlgorithm());
            mac.init(secretKeySpec);
            byte[] hash = mac.doFinal(s.getBytes(CHARSET));
            return DatatypeConverter.printBase64Binary(hash);
        } catch (Exception e) {
            log.error("[腾讯云] 签名生成异常", e);
            return "";
        }
    }

    public String getStringToSign(TreeMap<String, Object> params) {
        StringBuilder s2s = new StringBuilder("POST" + host + "/?");
        // 签名时要求对参数进行字典排序，此处用TreeMap保证顺序
        for (String k : params.keySet()) {
            s2s.append(k).append("=").append(params.get(k).toString()).append("&");
        }
        return s2s.toString().substring(0, s2s.length() - 1);
    }

}
```
