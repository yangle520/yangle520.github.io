---
layout: post
title:  时序数据库
date:   2024-01-17 00:00:00 +0800
categories: 基础知识
tag: 智慧矿山
---



* content
{:toc}






## 概述

时序数据库是用于存储和管理时序数据的专业化数据库。

时序数据是一种按时间顺序排列的数据，其主要特征是数据随时间变化而变化

时序数据库主要特点包括：高速的数据写入和查询能力，支持高吞吐和低延迟的数据访问，能够处理大规模的时序数据，支持多维数据分析和数据可视化，以及具备高可靠性和可拓展性等优点

时序数据库的应用场景非常广泛，例如物联网、工业自动化、金融、医疗等领域。例如，在物联网应用中，时序数据库可用于存储和处理传感器数据、设备数据和用户数据等，以实现实时监控、预测分析和智能决策等功能。在金融应用中，时序数据库可用于存储和分析股票、期货、外汇等金融数据，以支持高效的交易决策和风险管理。在医疗应用中，时序数据库可用于存储和处理患者的心电图、体温、血压等生理数据，以辅助医生进行疾病诊断和治疗。

### 数据写入特点

| 特点         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 高速写入     | 时序数据库通常采用批量写入、异步写入和压缩技术等方式来提高写入效率，保证数据写入速度的同时不影响系统的性 |
| 数据重复性   | 由于时序数据的连续生成特性，可能会出现重复的数据，这需要在数据写入时进行去重处理。为了避免影响写入效率，时序数据库通常采用基于哈希表的去重技术，能够快速有效地去重。 |
| 数据质量保障 | 时序数据库通常采用数据校验技术和数据采样等方式来保障数据的质量，防止出现数据错误和异常数据 |
| 时间戳保留   | 时序数据库需要保证时间戳的准确性和唯一性，以保证时序数据的完整性和时序性 |
| 数据压缩     | 时序数据库通常采用基于算法的数据压缩技术，能够有效减少数据存储空间和加快数据读取速度 |

### 数据查询特点

| 特点             | 说明                                                         |
| ---------------- | ------------------------------------------------------------ |
| 按时间范围读取   | 通常来说，你不会去关心某个特定点的数据，而是一段时间的数据   |
| 数据维度高       | 时序数据通常包含多个维度的数据，例如时间戳、测量值、传感器类型等，这使得数据查询和分析变得更加复杂 |
| 数据量大         | 时序数据通常包含大量的数据点，因此数据查询和分析需要处理大量数据，包括实时数据和历史数据 |
| 实时性要求高     | 时序数据的数据生成速度非常快，因此实时性要求很高。查询和分析操作需要快速响应，及时展现最新数据 |
| 时间序列相关性强 | 时序数据的数据点之间存在强相关性，即当前数据点和前一时刻或前几个时刻的数据点相关。因此时序数据查询和分析需要考虑数据点之间的相关性 |
| 数据聚合和计算   | 时序数据的查询和分析通常需要进行数据聚合和计算，例如求和、平均值、标准差、方差等操作，以便更好地展示数据趋势和变化 |

### 存储特点

| 特点           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| 数据量大       | 采集的监控数据的时间间隔是1s，那一个监控项每天会产生86400个数据点，若有10000个监控项，则一天就会产生864000000个数据点。在物联网场景下，这个数字会更大。整个数据的规模，是TB甚至是PB级的 |
| 冷热分明       | 时序数据有非常典型的冷热特征，越是历史的数据，被查询和分析的概率越低 |
| 具有时效性     | 时序数据具有时效性，数据通常会有一个保存周期，超过这个保存周期的数据可以认为是失效的，可以被回收。一方面是因为越是历史的数据，可利用的价值越低；另一方面是为了节省存储成本，低价值的数据可以被清理 |
| 多精度数据存储 | 在查询的特点里提到时序数据出于存储成本和查询效率的考虑，会需要一个多精度的查询，同样也需要一个多精度数据的存储 |



### 基本概念

**metric**: 度量，相当于关系型数据库中的 table

**data point**: 数据点，相当于关系型数据库中的 row

**timestamp**：时间戳，代表数据点产生的时间

**field**: 测量值，度量下的不同字段。一般情况下存放的是会随着时间戳的变化而变化的数据

**tag**: 标签，或者附加信息。一般存放的是并不随着时间戳变化的属性信息





## 常见时序数据库

### InfluxDB

单机版年费开源，集群版收费。

InfluxDB是自研存储，通过LSM tree的存储结构

支持高效的数据存储和查询，同时具有灵活的数据可视化和分析功能。

还支持多种数据格式和协议，包括 JSON、CSV、OpenTSDB 和 Graphite 等，可以与多种数据源进行集成。InfluxDB 的查询语言类似于 SQL，但是支持时间序列数据的特殊功能，如时间范围查询和聚合操作等



**Influxdb TSM 结构图**

![Influxdb_TSM_结构图]({{ '/styles/images/database/Influxdb_TSM_结构图.webp' | prepend: site.baseurl  }})



**缺点**：

1. InfluxDB拥有自己的查询语言和数据模型，学习和掌握这些概念和语法需要一定的时间和学习成本
2. 开源版本不支持集群部署



### kdb+

非开源

kdb+是一种高性能的时序数据库，专门用于处理和存储时序数据。它采用了一种独特的列存储架构和向量计算引擎，具有极高的数据处理速度和数据存储效率。

kdb+的列存储架构是其高性能的核心。与传统的行存储数据库不同，kdb+将数据按列存储，这种存储方式可以更好地支持数据压缩和向量计算，从而提高了数据的处理效率。此外，kdb+还支持多级索引和内存缓存等技术，进一步提高了数据的查询速度和存储效率。

kdb+支持各种数据类型和数据格式，如时间序列、tick数据、历史数据等，同时还支持多种查询方式和聚合操作，如统计、分组、排序等。这些功能使得kdb+成为金融行业、物联网、人工智能和科学研究等领域的首选时序数据库

官网：https://code.kx.com/q/learn/



### TimescaleDB

开源

TimescaleDB 是一种开源的分布式时序数据库，它是在 PostgreSQL 上构建的。TimescaleDB 支持高效的数据存储和查询，同时具有灵活的数据可视化和分析功能。

TimescaleDB 还支持 SQL，可以与 PostgreSQL 生态系统进行集成。TimescaleDB 的特点是可扩展性和高性能，它可以在多个节点上运行，并支持水平扩展，以处理更大的数据集。

官网：https://docs.timescale.com/



### OpenTSDB

开源

OpenTSDB 是一种开源的分布式时序数据库。支持高效的数据存储和查询，同时具有灵活的数据可视化和分析功能。

OpenTSDB 的特点是可扩展性和高性能，它可以在多个节点上运行，并支持水平扩展，以处理更大的数据集。OpenTSDB 还支持多种数据格式和协议，包括 JSON、CSV、Graphite 和 Collectd 等，可以与多种数据源进行集成。底层使用 Hbase 作为其分布式存储引擎，采用的也是 LSM tree

Hbase 采用范围划分的分片方式。使用 row key 做分片，保证其全局有序。每个 row key 下可以有多个 column family。每个 column family 下可以有多个 column

OpenTsdb 的 row key 组织方式：

```
[salt]<metric_uid><timestamp><tagk1><tagv1>[...<tagkn><tagvn>]
```

不同于别的时序数据库，由于 Hbase 的 row key 全局有序，所以增加了可选的 salt 以达到更好的数据分布，避免热点产生。再由与 timestamp 间的偏移和数据类型组成 column qualifier。

他的 timestamp 是小时对齐的，也就是说一个 row key 下最多存储一个小时的数据。并且需要将构成 row key 的 metric 和 tags 都转成对应的 uid 来减少存储空间，避免 Hfile 索引太大



### Apache IoTDB

开源

Apache IoTDB（物联网数据库）是一体化收集、存储、管理与分析物联网时序数据的软件系统。 Apache IoTDB 采用轻量式架构，具有高性能和丰富的功能，并与Apache Hadoop、Spark和Flink等进行了深度集成，可以满足工业物联网领域的海量数据存储、高速数据读取和复杂数据分析需求。



官网：https://iotdb.apache.org/





### Apache Druid

开源

Druid 是一种开源的分布式时序数据库和实时数据处理系统，它被设计用于存储、查询和分析大量时间序列数据。

Druid 支持高效的数据存储和查询，同时具有灵活的数据可视化和分析功能。Druid 的特点是可扩展性和高性能，它可以在多个节点上运行，并支持水平扩展，以处理更大的数据集。Druid 还支持多种数据格式和协议，包括 JSON、CSV 和 Avro 等，可以与多种数据源进行集成。



### 其他

Prometheus、Graphite 常用于集群监控组件，内置时序数据库存储模型

ClickHouse ：https://clickhouse.com/docs/zh
