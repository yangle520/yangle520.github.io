---
layout: post
title:  MySQL 性能优化
date:   2024-12-21
categories: mysql
tag: mysql
author: YangLe
---





## 性能问题

性能优化要做的就是以下事情：

- **了解基本原理**：找到事情的因果关系和依赖关系，让尽量不相关的事情能并行做起来
- **要事第一**：找到当前最重要、最需要优化的地方，投入时间和精力，不断去改进
- **切中要害**：找到耗费时间最长的地方，想方设法缩短它的时间



### 数据库的性能提升

一条 SQL 语句为了获取数据可以有几十甚至上百种执行计划，数据库会通过优化器选择更优的 SQL 执行计划，但是 MySQL 在执行计划上远远落后于商业数据库，甚至在一些方面相比 PostgreSQL 也差很多，那么怎么写出正确的SQL语句，避免 MySQL 选择错误的执行计划，以及怎样通过增加索引、设置参数让 MySQL 的执行计划更优，这就是优化 SQL 语句需要关心的事情。



数据库的性能优化最有效的是架构优化：

- 对于读多写少的应用程序，可以设计为读写分离，把允许延迟的读请求主动分发到备库；
- 对于秒杀型的业务，可以先在内存型 K-V 存储系统筛选再发往数据库持久化，避免对数据库的冲击
- 对于汇总、聚合类的应用，可以采用列式存储引擎或者专门的大数据平台
- 对于监控类的应用，可以采用时序数据库



## SQL优化

### 基础概念

**索引**

MySQL 中的索引桐城采用 B-Tree 结构。InnoDB中索引是B+Tree结构，在该结构中叶子阶段包含了非叶子节点的所有数据，并且叶子节点之间会通过指针连接。B-Tree 和 B+Tree 结构区别如下图：

![BTREE_B+TREE对比](D:\blog\yangle520.github.io\images\db\mysql\BTREE_B+TREE对比.png)

采用 B+Tree 结构，是因为数据库中有 > , < , between and 这类范围查询语句，之间扫描叶子节点即可。



**聚集索引（主键索引）**

InnoDB 的所有表都是索引组织表，主键与数据存放在一起。

1. 在创建表时，如果指定了主键，则将其作为聚集索引
2. 如果没有指定主键，则选择第一个 NOT NULL 的唯一索引作为聚集索引
3. 如果没有唯一索引，则内部会生成一个6字节的 rowid 作为主键

SQL 优化最重要的就是要减少 SQL 语句扫描的行数。

- **二级索引（辅助索引）**：二级索引的叶子节点存储了索引值+rowid(主键值)。 
- **基数**：字段 distinct 后的值，主键或非NULL 的唯一索引的基数等于表的总行数
- **选择性**：指基数与总行数的比值乘以，选择性通常表示在字段上是否适合创建索引
- **回表**：当要查询的字段不能在索引中完全获得时，则需要回表查询取出所需要的数据

通常在创建索引时要考虑以上内容(回表、基数、选择性)，在 MySQL 中可以通过系统表 innodb_index_stats 来查看索引选择性如何，并且可以看到组合索引中每一个字段的选择性如何，还可以计算索引的大小。



## 性能测试

### 测试目标

主要包含两类：

- **已知故障信息采集**：对故障现场的还原和重现，需要多个维度详细地收集故障地现象、日志、监控报警地异常、数据库和系统地异常表现、发现故障人员额外了解地信息等。
- **预估压力评测**：评估和确认服务器、系统、数据库配置或者业务在一定压力下，数据库到底能承受多大地压力。
  - **自下而上**：数据库到底能承载多大地并发量，性能余量还有多少，空间使用情况时怎样地，监控和备份还有哪些可以改进等。-- 负责服务器管理、高可用设计、数据零丢失设计、自动化扩缩容以及日常故障/异常地处理
  - **自上而下**：在业务上什么时间段时高峰期、什么时间段是低谷期，高峰期 QPS 大概是多少，是什么业务并发导致地，业务异常会对其他哪些模块有影响。规划数据存储：
    - 哪些数据放在数据库中；
    - 哪些数据需要缓存起来；
    - 哪些数据放在搜索引擎中；
    - 哪些数据放在数据仓库或者大数据平台；
    - 整理数据流
    - 数据是直接落到数据库中还是走消息中间件，在线数据怎么同步到数据仓库和搜索引擎
    - 提升数据库访问效率
    - 表结构设计的范式和反范式，SQL 语句编写规范和 SQL 优化



### 测试指标

| 指标    | 说明                                                         |
| ------- | ------------------------------------------------------------ |
| QPS     | 衡量数据库的 SQL 处理能力的指标。每秒 MYSQL 承载的请求数据   |
| TPS     | 衡量数据库的事务处理能力的指标。每秒事务提交和回滚的次数     |
| IOPS    | 衡量存储系统的随机 I/O 并发处理能力的指标                    |
| 吞吐量  | 衡量存储系统的顺序 I/O 处理能力的指标                        |
| latency | 衡量存储系统的 I/O 响应速度的指标                            |
| 95th    | 按照服务响应结构排序，从小到大排序位置为95%的响应结构。用于评估服务响应的质量。 |
| 抖动    | 如果每次响应时间相差都非常打，则说明系统很不稳定。用于评估系统的稳定性 |
| 直方图  | 用于统计服务响应的分布区间情况                               |

