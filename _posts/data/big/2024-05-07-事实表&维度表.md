---
layout: post
title:  事实表&维度表
date:   2024-05-06 00:00:00 +0800
categories: 大数据
tag: 大数据
author: YangLe
---





## 一、维度建模

### 1、设计步骤

选择业务过程 -> 声明粒度 -> 确认维度 -> 确认事实

#### 1.1 选择业务过程

业务过程是组织完成的操作型活动。例如注册用户、下订单，开具发票，付款、处理索赔等。

业务过程通常用行为动词表示。因为他们通常表示业务执行的活动。与之相关的维度描述与某个业务过程时间关联的描述环境。业务过程通常由某个操作系统支撑，例如账单或购买系统。

#### 1.2 声明粒度

先举个例子：对于用户来说，一个用户有一个身份证号，一个户籍地址，多个手机号，多张银行卡，那么与用户粒度相同的粒度属性有身份证粒度，户籍地址粒度，比用户粒度更细的粒度有手机号粒度，银行卡粒度，存在一对一的关系就是相同粒度。为什么要提相同粒度呢，因为维度建模中要求我们，在同一事实表中，必须具有相同的粒度，同一事实表中不要混用多种不同的粒度，不同的粒度数据建立不同的事实表。并且从给定的业务过程获取数据时，强烈建议从关注原子粒度开始设计，也就是从最细粒度开始，因为原子粒度能够承受无法预期的用户查询。但是上卷汇总粒度对查询性能的提升很重要的，所以对于有明确需求的数据，我们建立针对需求的上卷汇总粒度，对需求不明朗的数据我们建立原子粒度。

#### 1.3 确认维度

维度围绕某一业务过程事件所涉及的谁、什么、何处、何时、为什么、如何等背景。维度表包含BI应用所需要的用于过滤及分类事实的描述性属性。牢牢掌握事实表的粒度，就能够将所有可能存在的维度区分开。当与给定的事实表关联时，任何情况都能保证维度表唯一值。

数仓工具箱中告诉我们牢牢掌握事实表的粒度，就能将所有可能存在的维度区分开，并且要确保维度表中不能出现重复数据，应使维度主键唯一

#### 1.4 确认用于度量的事实

事实表是用来度量的，基本上都以数量值表示，事实表中的每行对应一个度量，每行中的数据是一个特定级别的细节数据，称为粒度。维度建模的核心原则之一是同一事实表中的所有度量必须具有相同的粒度。这样能确保不会出现重复计算度量的问题。有时候往往不能确定该列数据是事实属性还是维度属性。记住最实用的事实就是数值类型和可加类事实。所以可以通过分析该列是否是一种包含多个值并作为计算的参与者的度量，这种情况下该列往往是事实。

明显属于不同粒度的事实必须放在不同的事实表中。典型事实是可加性数值，例如订货数量是以美元计的成本总额等。

#### 1.5 确定命名规范

在详细设计之前，为 DW / BI 系统制定规范，主要包含源系统、主题、业务术语、报表，物理设计命名、调度任务、文档方面的规范。

#### 1.6 编写详细设计映射文档

详细设计文档包括从源系统到维度模型的每个数据层的物理映射文档。

#### 1.7 审查和验证模型

详细设计文档出来后，要和业务用户和团队成员进行评审，记录下来评审过程中的问题，形成问题清单。

#### 1.8 完成设计文档

最后确定设计文档，进行下一步的ETL开发。

## 二、事实表

事实表存储了从业务活动或事件提炼出来的性能度量，它主要包含维度表的外键和连续变化的可加性数值或半可加事实。事实表产生于业务过程中而不是业务过程的描述性信息。它一般是行多列少，占了数据仓库的90%的空间。在维度模型中也有表示多对多关系的事实，其他都是维度表。

**事实表粒度**：事实表的粒度是产生事实行的度量事件的业务定义。粒度确定了事实表的业务主键， 事实表的所有度量值必须具有相同的粒度。

### 1、事实表类型

数仓分层：

- 贴源数据层ODS
- 统一数仓层DW：细分为明细数据层DWD、汇总数据层DWS
- 标签数据层TDM
- 应用数据层ADS。

其中，DW层采用维度建模的思想，包含维度表与事实表。

#### 1.1 事务事实表

类似于mysql binlog日志，每一次相关的 change 都记录下来，生成一行新的数据

1. 明细事实表： 一般位于DWD层，该层事实表设计不进行聚合、汇总等动作，仅做数据规范化，数据降维动作，同时数据保持业务事务粒度，确保数据信息无丢失。
   单事件事实表：更方便跟踪业务流程细节数据，针对特殊的业务分析场景比较方便和灵活，数据处理上也更加灵活
2. 聚合事实表

#### 1.2 周期快照事实表

周期事实表就是每行都带有时间值字段，代表周期，通常时间值都是标准周期，如某一天，某周，某月等。粒度是周期，而不是个体的事务，也就是说一个周期快照事实表中数据可以是多个事实，但是它们都属于某个周期内。

例如购物车，有加减商品，随时都有可能变化，但是我们更关心每天结束时这里面有多少商品，例如每天或者每月的销售额，或每月的账户余额等。方便我们后期统计分析。

它是按照良好的时间周期间隔(每天，每月)来捕捉业务活动的执行情况，一旦装入事实表就不会再去更新，它是事务事实表的补充，而非替代品。

#### 1.3 累积快照事实表

它用于描述业务过程中某个不确定时间跨度里的活动，它随着业务活动的发生会不断的更新。 

### 2、设计原则

**原则 1：尽可能包含所有与业务过程相关的事实**

分析哪些事实与业务过程相关，是设计过程中非常重要的关注点；在事实表中，尽量包含所有与业务过程相关的事实，即使存在冗余，由于事实通常是数字型，存储开销不会太大；

**原则 2：只选择与业务过程相关的事实**

如，订单的下单这个业务过程，事实表中不应该存在支付金额这个表示支付业务过程的事实；

**原则 3：分解不可加性事实为可加的组件**

如，订单的优惠率，应分解为订单原价金额与订单优惠金额两个事实存储在事实表中；

**原则 4：在选择维度和事实之前必须先声明粒度**

- 粒度用于确定事实表中一行所表示业务的细节层次，决定了维度模型的扩展性；
- 每个维度和事实必须与所定义的粒度保持一致；
- 设计事实表时，粒度定义越细越好，一般从最低级别的原子粒度开始；
- 因为原子粒度提供了最大限度的灵活性，可以支持无法预期的各种细节层次的用户需求；

**原则 5：在同一个事实表中不能有多种不同粒度的事实**

**原则 6：事实的单位要保持一致**

如，订单金额、订单优惠金额、订单运费这 3 个事实，应该采用统一的计量单位，统一为元或者分，以方便使用；

**原则 7：对事实的 null 值要处理**

在数据库中，null 值对常用数字型字段的 SQL 过滤条件都不生效；如，大于、小于、等于、大于或等于、小于或等于；处理：用 0 代替 null 

**原则 8：使用退化维度提高事实表的易用性**

## 三、维度表

维度表是对业务过程的上下文描述，主要包含代理键、文本信息和离散的数字。它是进入事实表的入口，丰富的维度属性给出了对事实表的分析切割能力，它一般是行少列多。如果属性值是离散的，用于过滤和标记的，就放到维度表里，如果是属性值是连续取值，用于计算的，就放到事实表中。

### 1、维度表类型

#### 1.1 稳定维度表

部分维度表的维度是在维度表产生以后，属性是稳定的，无变化的。例：时间维度，区域维度

#### 1.2 缓慢变化维度表

维度数据会随着时间发生变化，变化速度非常缓慢。例：电商平台的用户维度表，用户的收货地址是缓慢变化的。

### 2、退化维度、维度退化

退化维度就是将维度退回到事实表中，宽表。因为有时维度除了主键没有其他内容，虽然也是合法维度键，但是一般都会退回到事实表中，减少关联次数，提高查询性能

DWD有简单的维度信息冗余到事实表

DWS汇总数据，指标的维度退化，采取更多的宽表化手段构建公共指标数据层，提升公共指标的复用性，减少重复加工

ADS应用层宽表，维度冗余的

## 四、大宽表

### 1、优点

- 提高查询性能
- 快速响应
- 方便使用，降低使用成本：单表查询即可，不用复杂join
- 构建公共指标数据层，提升公共指标的复用性，减少重复加工。
- 提高用户满意度

### 2、缺点

- 数据冗余
- 另外就是灵活性差，就比如说线上业务表结构变更，宽表模式改造量也比较大
- 开发宽表为了避免宽表重复迭代，我们应该去了解业务全流程，得需要知道需扩展哪些维度，沉淀哪些指标，这样就流程会比较长，特别是有些业务快速迭代的话，就有点捉襟见肘